<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>{{container}} - xterm</title>
    <link rel="icon" href="/static/assets/favicon.ico">
    <style>
html {
  font-family: arial;
}
body {
  width: 100vw;
  height: 100vh;
}
#terminal {
  width: 100%;
  height: calc(100% - 50px);
}
    </style>
    <link rel="stylesheet" href="/static/assets/plugins/xterm/xterm/css/xterm.css"/>
  </head>
  <body>
    <!-- Analytics measurements -->
    {% if config.ANALYTICS_JSFILE %}
    <script async src="{{config.ANALYTICS_JSFILE}}"></script>
    {% endif %}
    {% if config.ANALYTICS_SCRIPT %}
    <script>
    {{config.ANALYTICS_SCRIPT|safe}}
    </script>
    {% endif %}
    <div id="terminal"></div>
    <!-- xterm -->
    <script src="/static/assets/plugins/xterm/xterm/lib/xterm.js"></script>
    <script src="/static/assets/plugins/xterm/addon-fit/lib/addon-fit.js"></script>
    <script src="/static/assets/plugins/xterm/addon-web-links/lib/addon-web-links.js"></script>
    <script src="/static/assets/plugins/xterm/addon-search/lib/addon-search.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.min.js"></script>

    <script>
      const term = new Terminal({
        cursorBlink: true,
        macOptionIsMeta: true,
        scrollback: 999999,
      });
      term.attachCustomKeyEventHandler(customKeyEventHandler);
      // https://github.com/xtermjs/xterm.js/issues/2941
      const fit = new FitAddon.FitAddon();
      term.loadAddon(fit);
      term.loadAddon(new WebLinksAddon.WebLinksAddon());
      term.loadAddon(new SearchAddon.SearchAddon());

      term.open(document.getElementById("terminal"));
      fit.fit();
      term.resize(15, 50);
      fit.fit();
      term.writeln("Welcome to {{host}}");
      term.writeln('')
      term.writeln("You can copy with ctrl+shift+c or ctrl+shift+x");
      term.writeln("You can paste with ctrl+shift+v");
      term.writeln("You can clear with ctrl+l");
      term.writeln('')
      term.focus();
      term.onData((data) => {
        socket.emit("pty-input", { input: data, host: "{{host}}" });
      });

      const socket = io.connect("/pty?host={{host}}");
      const status = document.getElementById("status");

      socket.on("pty-output", function (data) {
        term.write(data.output);
      });

      socket.on("server-disconnected", function (data) {
        console.log("server-disconnected {{host}}");
        window.close();
        term.dispose();
        //socket.disconnect();
      });

      socket.on("connect", () => {
        fitToscreen();
      });

      socket.on("disconnect", () => {
        console.log("disconnected {{host}}");
      });

      function fitToscreen() {
        fit.fit();
        const dims = { cols: term.cols, rows: term.rows };
        socket.emit("resize", { dims: dims, host: "{{host}}" });
      }

      function debounce(func, wait_ms) {
        let timeout;
        return function (...args) {
          const context = this;
          clearTimeout(timeout);
          timeout = setTimeout(() => func.apply(context, args), wait_ms);
        };
      }

      /**
       * Handle copy and paste events
       */
      function customKeyEventHandler(e) {
        if (e.type !== "keydown") {
          return true;
        }
        if (e.ctrlKey && e.shiftKey) {
          const key = e.key.toLowerCase();
          if (key === "v") {
            // ctrl+shift+v: paste whatever is in the clipboard
            navigator.clipboard.readText().then((toPaste) => {
              term.paste(toPaste);
            });
            return false;
          } else if (key === "c" || key === "x") {
            // ctrl+shift+x: copy whatever is highlighted to clipboard

            // 'x' is used as an alternate to 'c' because ctrl+c is taken
            // by the terminal (SIGINT) and ctrl+shift+c is taken by the browser
            // (open devtools).
            // I'm not aware of ctrl+shift+x being used by anything in the terminal
            // or browser
            const toCopy = term.getSelection();
            navigator.clipboard.writeText(toCopy);
            term.focus();
            return false;
          }
        }
        if (e.ctrlKey) {
          const key = e.key.toLowerCase();
          if (key === "l") {
            term.clear();
            return false;
          }
        }
        return true;
      }

      const wait_ms = 50;
      window.onresize = debounce(fitToscreen, wait_ms);

      window.onbeforeunload = function () {
        socket.emit('disconnect', {'host': "{{host}}"});
      }
    </script>
  </body>
</html>
